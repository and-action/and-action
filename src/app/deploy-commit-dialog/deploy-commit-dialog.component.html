<h2 class="dialog-title" mat-dialog-title>
  <mat-icon class="dialog-title__icon">rocket_launch</mat-icon>
  <span>Deploy to {{ dialogData.repository.name }}</span>
</h2>
<mat-dialog-content>
  <ana-commit-info
    class="u-margin-bottom-xl"
    [commit]="dialogData.commitToDeploy"
    [repositoryUrl]="dialogData.repository.url"
  >
  </ana-commit-info>

  @if (environments$ | async; as environments) {
    @if (environments.length === 0) {
      <p class="u-text-placeholder">No environment configuration found.</p>
      <p class="u-text-placeholder">
        Please make sure that you have a .github/andaction.yml file either in
        your repository or in your organization's .github repository containing
        the key "environments".
      </p>
      <p class="u-text-placeholder">
        For more information, please see the documentation about
        <a
          class="text-link"
          href="https://github.com/and-action/and-action/tree/master#commits--deployments"
          target="_blank"
          rel="noopener"
        >
          Commits & Deployments
        </a>
        and
        <a
          class="text-link"
          href="https://github.com/and-action/and-action/tree/master#configuration"
          target="_blank"
          rel="noopener"
        >
          Configuration
        </a>
        .
      </p>
    }
    <div class="environment-list">
      @for (
        environment of environments;
        track environment;
        let index = $index
      ) {
        <p
          [style]="{
            'background-color': environmentColorMapping[environment.name]
          }"
          class="environment__tag"
        >
          {{ environment.name }}
        </p>

        <button
          mat-flat-button
          color="primary"
          type="button"
          class="environment__action"
          (click)="deployToEnvironment(environment, environments)"
          [disabled]="!environment.canBeDeployed.value || isLoading"
        >
          {{ getDeployButtonLabel(environment.deploymentType) }}
        </button>

        <div class="environment__text">
          @if (environment.deploymentDate) {
            <p>
              Deploy triggered on
              {{ environment.deploymentDate | date: dateFormat }} at
              {{ environment.deploymentDate | date: 'H:mm:ss' }}
            </p>
          }
          @if (!environment.canBeDeployed.value) {
            <p
              class="u-text-placeholder"
              [innerHTML]="environment.canBeDeployed.reason"
            ></p>
          }
        </div>

        <div class="environment__state">
          @if (environment.deploymentState) {
            <p
              class="environment__state-tag"
              [ngClass]="getStateTagCssClass(environment.deploymentState)"
            >
              {{ getDeploymentStateOutputText(environment.deploymentState) }}
            </p>
          }
        </div>
        <mat-divider></mat-divider>
      }
    </div>
  }
</mat-dialog-content>

<div mat-dialog-actions align="end">
  <button
    type="button"
    mat-button
    mat-dialog-close
    color="primary"
    [disabled]="isLoading"
  >
    Close
  </button>
</div>

@if (isLoading) {
  <div class="dialog-progress">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>
}
